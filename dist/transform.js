"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.transformDiff = void 0;
const cfnDiff = require("@aws-cdk/cloudformation-diff");
const through2 = require("through2");
const util_1 = require("./util");
const types_1 = require("./types");
const cdk_reverse_engineered_1 = require("./cdk-reverse-engineered");
// unable to emulate the --no-colors option, (tried passing no-colors option to cdk Configuration class to no avail)
// this is workaround to remove the colors tty elements
const fixRemoveColors = (input) => JSON.parse(JSON.stringify(input).replace(/\\u001b\[[^m]+m/g, ''));
const buildRaw = async (diff) => {
    const strm = through2();
    cfnDiff.formatDifferences(strm, diff.rawDiff, diff.logicalToPathMap);
    strm.end();
    return fixRemoveColors(await util_1.streamToString(strm));
};
const buildChangeAction = (oldValue, newValue) => {
    if (oldValue !== undefined && newValue !== undefined) {
        return "UPDATE";
    }
    else if (oldValue !== undefined) {
        return "REMOVAL";
    }
    else {
        return "ADDITION";
    }
};
const transformIamChanges = async (diff) => {
    if (!diff.rawDiff.iamChanges.hasChanges) {
        return [];
    }
    const result = [];
    if (diff.rawDiff.iamChanges.statements.hasChanges) {
        const statementsSummarized = diff.rawDiff.iamChanges.summarizeStatements();
        result.push({
            label: "IAM Statement Changes",
            cdkDiffRaw: fixRemoveColors(cfnDiff.formatTable(cdk_reverse_engineered_1.deepSubstituteBracedLogicalIds(diff.logicalToPathMap)(statementsSummarized), undefined)),
        });
    }
    if (diff.rawDiff.iamChanges.managedPolicies.hasChanges) {
        const managedPoliciesSummarized = diff.rawDiff.iamChanges.summarizeManagedPolicies();
        result.push({
            label: "IAM Policy Changes",
            cdkDiffRaw: fixRemoveColors(cfnDiff.formatTable(cdk_reverse_engineered_1.deepSubstituteBracedLogicalIds(diff.logicalToPathMap)(managedPoliciesSummarized), undefined)),
        });
    }
    return result;
};
const transformSecurityGroupChanges = async (diff) => {
    if (!diff.rawDiff.securityGroupChanges.hasChanges) {
        return [];
    }
    const summarized = diff.rawDiff.securityGroupChanges.summarize();
    return [
        {
            label: "Security Group Changes",
            cdkDiffRaw: fixRemoveColors(cfnDiff.formatTable(cdk_reverse_engineered_1.deepSubstituteBracedLogicalIds(diff.logicalToPathMap)(summarized), undefined)),
        },
    ];
};
const processIndividualDiff = (result, cdkDiffCategory) => (id, rdiff) => {
    var _a, _b, _c, _d;
    if (rdiff.isDifferent) {
        const resourceType = types_1.guardResourceDiff(rdiff)
            ? (rdiff.isRemoval ? (_a = rdiff.oldValue) === null || _a === void 0 ? void 0 : _a.Type : (_b = rdiff.newValue) === null || _b === void 0 ? void 0 : _b.Type) ||
                cdkDiffCategory
            : (((_c = rdiff.oldValue) === null || _c === void 0 ? void 0 : _c.Type) || ((_d = rdiff.newValue) === null || _d === void 0 ? void 0 : _d.Type) || cdkDiffCategory);
        const changes = [];
        if (types_1.guardResourceDiff(rdiff) && rdiff.isUpdate) {
            rdiff.forEachDifference((_, label, values) => {
                changes.push({
                    label,
                    action: buildChangeAction(values.oldValue, values.newValue),
                    from: values.oldValue,
                    to: values.newValue,
                });
            });
        }
        result.push({
            label: cdkDiffCategory,
            cdkDiffRaw: JSON.stringify({ id, diff: rdiff }, null, 2),
            nicerDiff: {
                resourceType,
                changes,
                cdkDiffCategory,
                resourceAction: rdiff.isAddition
                    ? "ADDITION"
                    : rdiff.isRemoval
                        ? "REMOVAL"
                        : "UPDATE",
                resourceLabel: id,
            },
        });
    }
};
const transformDiffForResourceTypes = async (diff) => {
    const result = [];
    for (const d of Object.entries(diff.rawDiff).filter(([k]) => !["iamChanges", "securityGroupChanges"].includes(k))) {
        const { diffCollectionKey, diffCollection } = types_1.diffValidator(d);
        if (diffCollection.differenceCount > 0) {
            diffCollection.forEachDifference(processIndividualDiff(result, diffCollectionKey));
        }
    }
    return result;
};
exports.transformDiff = async (diff) => {
    if (diff.rawDiff.isEmpty) {
        return {
            stackName: diff.stackName,
            raw: "There were no differences",
            diff: [],
        };
    }
    return {
        stackName: diff.stackName,
        raw: await buildRaw(diff),
        diff: [
            ...(await transformIamChanges(diff)),
            ...(await transformSecurityGroupChanges(diff)),
            ...(await transformDiffForResourceTypes(diff)),
        ],
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RyYW5zZm9ybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx3REFBd0Q7QUFDeEQscUNBQXFDO0FBRXJDLGlDQUF3QztBQUN4QyxtQ0FRaUI7QUFDakIscUVBQTBFO0FBRTFFLG9IQUFvSDtBQUNwSCx1REFBdUQ7QUFDdkQsTUFBTSxlQUFlLEdBQUcsQ0FBQyxLQUFhLEVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUVwSCxNQUFNLFFBQVEsR0FBRyxLQUFLLEVBQUUsSUFBa0IsRUFBbUIsRUFBRTtJQUM3RCxNQUFNLElBQUksR0FBRyxRQUFRLEVBQUUsQ0FBQztJQUN4QixPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDckUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ1gsT0FBTyxlQUFlLENBQUMsTUFBTSxxQkFBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDckQsQ0FBQyxDQUFDO0FBRUYsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLFFBQWEsRUFBRSxRQUFhLEVBQUUsRUFBRTtJQUN6RCxJQUFJLFFBQVEsS0FBSyxTQUFTLElBQUksUUFBUSxLQUFLLFNBQVMsRUFBRTtRQUNwRCxPQUFPLFFBQVEsQ0FBQztLQUNqQjtTQUFNLElBQUksUUFBUSxLQUFLLFNBQVMsRUFBRTtRQUNqQyxPQUFPLFNBQVMsQ0FBQztLQUNsQjtTQUFNO1FBQ0wsT0FBTyxVQUFVLENBQUM7S0FDbkI7QUFDSCxDQUFDLENBQUM7QUFFRixNQUFNLG1CQUFtQixHQUFHLEtBQUssRUFDL0IsSUFBa0IsRUFDSSxFQUFFO0lB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QyxFQUFFO1lBQ3RDLGNBQWMsQ0FBQyxpQkFBaUIsQ0FDOUIscUJBQXFCLENBQUMsTUFBTSxFQUFFLGlCQUFpQixDQUFDLENBQ2pELENBQUM7U0FDSDtLQUNGO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxDQUFDO0FBRVcsUUFBQSxhQUFhLEdBQUcsS0FBSyxFQUNoQyxJQUFrQixFQUNPLEVBQUU7SUFDM0IsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtRQUN4QixPQUFPO1lBQ0wsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLEdBQUcsRUFBRSwyQkFBMkI7WUFDaEMsSUFBSSxFQUFFLEVBQUU7U0FDVCxDQUFDO0tBQ0g7SUFFRCxPQUFPO1FBQ0wsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1FBQ3pCLEdBQUcsRUFBRSxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDekIsSUFBSSxFQUFFO1lBQ0osR0FBRyxDQUFDLE1BQU0sbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDcEMsR0FBRyxDQUFDLE1BQU0sNkJBQTZCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDOUMsR0FBRyxDQUFDLE1BQU0sNkJBQTZCLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDL0M7S0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2ZuRGlmZiBmcm9tIFwiQGF3cy1jZGsvY2xvdWRmb3JtYXRpb24tZGlmZlwiO1xuaW1wb3J0ICogYXMgdGhyb3VnaDIgZnJvbSBcInRocm91Z2gyXCI7XG5cbmltcG9ydCB7IHN0cmVhbVRvU3RyaW5nIH0gZnJvbSBcIi4vdXRpbFwiO1xuaW1wb3J0IHtcbiAgQ2RrRGlmZkNhdGVnb3J5LFxuICBkaWZmVmFsaWRhdG9yLFxuICBndWFyZFJlc291cmNlRGlmZixcbiAgTmljZXJEaWZmLFxuICBOaWNlckRpZmZDaGFuZ2UsXG4gIE5pY2VyU3RhY2tEaWZmLFxuICBTdGFja1Jhd0RpZmYsXG59IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgeyBkZWVwU3Vic3RpdHV0ZUJyYWNlZExvZ2ljYWxJZHMgfSBmcm9tIFwiLi9jZGstcmV2ZXJzZS1lbmdpbmVlcmVkXCI7XG5cbi8vIHVuYWJsZSB0byBlbXVsYXRlIHRoZSAtLW5vLWNvbG9ycyBvcHRpb24sICh0cmllZCBwYXNzaW5nIG5vLWNvbG9ycyBvcHRpb24gdG8gY2RrIENvbmZpZ3VyYXRpb24gY2xhc3MgdG8gbm8gYXZhaWwpXG4vLyB0aGlzIGlzIHdvcmthcm91bmQgdG8gcmVtb3ZlIHRoZSBjb2xvcnMgdHR5IGVsZW1lbnRzXG5jb25zdCBmaXhSZW1vdmVDb2xvcnMgPSAoaW5wdXQ6IHN0cmluZyk6IHN0cmluZyA9PiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGlucHV0KS5yZXBsYWNlKC9cXFxcdTAwMWJcXFtbXm1dK20vZywgJycpKVxuXG5jb25zdCBidWlsZFJhdyA9IGFzeW5jIChkaWZmOiBTdGFja1Jhd0RpZmYpOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICBjb25zdCBzdHJtID0gdGhyb3VnaDIoKTtcbiAgY2ZuRGlmZi5mb3JtYXREaWZmZXJlbmNlcyhzdHJtLCBkaWZmLnJhd0RpZmYsIGRpZmYubG9naWNhbFRvUGF0aE1hcCk7XG4gIHN0cm0uZW5kKCk7XG4gIHJldHVybiBmaXhSZW1vdmVDb2xvcnMoYXdhaXQgc3RyZWFtVG9TdHJpbmcoc3RybSkpO1xufTtcblxuY29uc3QgYnVpbGRDaGFuZ2VBY3Rpb24gPSAob2xkVmFsdWU6IGFueSwgbmV3VmFsdWU6IGFueSkgPT4ge1xuICBpZiAob2xkVmFsdWUgIT09IHVuZGVmaW5lZCAmJiBuZXdWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIFwiVVBEQVRFXCI7XG4gIH0gZWxzZSBpZiAob2xkVmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBcIlJFTU9WQUxcIjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gXCJBRERJVElPTlwiO1xuICB9XG59O1xuXG5jb25zdCB0cmFuc2Zvcm1JYW1DaGFuZ2VzID0gYXN5bmMgKFxuICBkaWZmOiBTdGFja1Jhd0RpZmZcbik6IFByb21pc2U8TmljZXJEaWZmW10+ID0+IHtcbiAgaWYgKCFkaWZmLnJhd0RpZmYuaWFtQ2hhbmdlcy5oYXNDaGFuZ2VzKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0OiBOaWNlckRpZmZbXSA9IFtdO1xuICBpZiAoZGlmZi5yYXdEaWZmLmlhbUNoYW5nZXMuc3RhdGVtZW50cy5oYXNDaGFuZ2VzKSB7XG4gICAgY29uc3Qgc3RhdGVtZW50c1N1bW1hcml6ZWQgPSBkaWZmLnJhd0RpZmYuaWFtQ2hhbmdlcy5zdW1tYXJpemVTdGF0ZW1lbnRzKCk7XG4gICAgcmVzdWx0LnB1c2goe1xuICAgICAgbGFiZWw6IFwiSUFNIFN0YXRlbWVudCBDaGFuZ2VzXCIsXG4gICAgICBjZGtEaWZmUmF3OiBmaXhSZW1vdmVDb2xvcnMoXG4gICAgICAgIGNmbkRpZmYuZm9ybWF0VGFibGUoXG4gICAgICAgICAgZGVlcFN1YnN0aXR1dGVCcmFjZWRMb2dpY2FsSWRzKGRpZmYubG9naWNhbFRvUGF0aE1hcCkoXG4gICAgICAgICAgICBzdGF0ZW1lbnRzU3VtbWFyaXplZFxuICAgICAgICAgICksXG4gICAgICAgICAgdW5kZWZpbmVkXG4gICAgICAgIClcbiAgICAgICksXG4gICAgfSk7XG4gIH1cblxuICBpZiAoZGlmZi5yYXdEaWZmLmlhbUNoYW5nZXMubWFuYWdlZFBvbGljaWVzLmhhc0NoYW5nZXMpIHtcbiAgICBjb25zdCBtYW5hZ2VkUG9saWNpZXNTdW1tYXJpemVkID1cbiAgICAgIGRpZmYucmF3RGlmZi5pYW1DaGFuZ2VzLnN1bW1hcml6ZU1hbmFnZWRQb2xpY2llcygpO1xuICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgIGxhYmVsOiBcIklBTSBQb2xpY3kgQ2hhbmdlc1wiLFxuICAgICAgY2RrRGlmZlJhdzogZml4UmVtb3ZlQ29sb3JzKFxuICAgICAgICBjZm5EaWZmLmZvcm1hdFRhYmxlKFxuICAgICAgICAgIGRlZXBTdWJzdGl0dXRlQnJhY2VkTG9naWNhbElkcyhkaWZmLmxvZ2ljYWxUb1BhdGhNYXApKFxuICAgICAgICAgICAgbWFuYWdlZFBvbGljaWVzU3VtbWFyaXplZFxuICAgICAgICAgICksXG4gICAgICAgICAgdW5kZWZpbmVkXG4gICAgICAgIClcbiAgICAgICksXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgdHJhbnNmb3JtU2VjdXJpdHlHcm91cENoYW5nZXMgPSBhc3luYyAoXG4gIGRpZmY6IFN0YWNrUmF3RGlmZlxuKTogUHJvbWlzZTxOaWNlckRpZmZbXT4gPT4ge1xuICBpZiAoIWRpZmYucmF3RGlmZi5zZWN1cml0eUdyb3VwQ2hhbmdlcy5oYXNDaGFuZ2VzKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY29uc3Qgc3VtbWFyaXplZCA9IGRpZmYucmF3RGlmZi5zZWN1cml0eUdyb3VwQ2hhbmdlcy5zdW1tYXJpemUoKTtcblxuICByZXR1cm4gW1xuICAgIHtcbiAgICAgIGxhYmVsOiBcIlNlY3VyaXR5IEdyb3VwIENoYW5nZXNcIixcbiAgICAgIGNka0RpZmZSYXc6IGZpeFJlbW92ZUNvbG9ycyhcbiAgICAgICAgY2ZuRGlmZi5mb3JtYXRUYWJsZShcbiAgICAgICAgICBkZWVwU3Vic3RpdHV0ZUJyYWNlZExvZ2ljYWxJZHMoZGlmZi5sb2dpY2FsVG9QYXRoTWFwKShzdW1tYXJpemVkKSxcbiAgICAgICAgICB1bmRlZmluZWRcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICB9LFxuICBdO1xufTtcblxuY29uc3QgcHJvY2Vzc0luZGl2aWR1YWxEaWZmID1cbiAgKHJlc3VsdDogTmljZXJEaWZmW10sIGNka0RpZmZDYXRlZ29yeTogQ2RrRGlmZkNhdGVnb3J5KSA9PlxuICAoaWQ6IHN0cmluZywgcmRpZmY6IGNmbkRpZmYuRGlmZmVyZW5jZTxhbnk+KSA9PiB7XG4gICAgaWYgKHJkaWZmLmlzRGlmZmVyZW50KSB7XG4gICAgICBjb25zdCByZXNvdXJjZVR5cGU6IHN0cmluZyA9IGd1YXJkUmVzb3VyY2VEaWZmKHJkaWZmKVxuICAgICAgICA/IChyZGlmZi5pc1JlbW92YWwgPyByZGlmZi5vbGRWYWx1ZT8uVHlwZSA6IHJkaWZmLm5ld1ZhbHVlPy5UeXBlKSB8fFxuICAgICAgICAgIGNka0RpZmZDYXRlZ29yeVxuICAgICAgICA6IChyZGlmZi5vbGRWYWx1ZT8uVHlwZSB8fCByZGlmZi5uZXdWYWx1ZT8uVHlwZSB8fCBjZGtEaWZmQ2F0ZWdvcnkpO1xuICAgICAgY29uc3QgY2hhbmdlczogTmljZXJEaWZmQ2hhbmdlW10gPSBbXTtcbiAgICAgIGlmIChndWFyZFJlc291cmNlRGlmZihyZGlmZikgJiYgcmRpZmYuaXNVcGRhdGUpIHtcbiAgICAgICAgcmRpZmYuZm9yRWFjaERpZmZlcmVuY2UoKF8sIGxhYmVsLCB2YWx1ZXMpID0+IHtcbiAgICAgICAgICBjaGFuZ2VzLnB1c2goe1xuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICBhY3Rpb246IGJ1aWxkQ2hhbmdlQWN0aW9uKHZhbHVlcy5vbGRWYWx1ZSwgdmFsdWVzLm5ld1ZhbHVlKSxcbiAgICAgICAgICAgIGZyb206IHZhbHVlcy5vbGRWYWx1ZSxcbiAgICAgICAgICAgIHRvOiB2YWx1ZXMubmV3VmFsdWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgIGxhYmVsOiBjZGtEaWZmQ2F0ZWdvcnksXG4gICAgICAgIGNka0RpZmZSYXc6IEpTT04uc3RyaW5naWZ5KHsgaWQsIGRpZmY6IHJkaWZmIH0sIG51bGwsIDIpLFxuICAgICAgICBuaWNlckRpZmY6IHtcbiAgICAgICAgICByZXNvdXJjZVR5cGUsXG4gICAgICAgICAgY2hhbmdlcyxcbiAgICAgICAgICBjZGtEaWZmQ2F0ZWdvcnksXG4gICAgICAgICAgcmVzb3VyY2VBY3Rpb246IHJkaWZmLmlzQWRkaXRpb25cbiAgICAgICAgICAgID8gXCJBRERJVElPTlwiXG4gICAgICAgICAgICA6IHJkaWZmLmlzUmVtb3ZhbFxuICAgICAgICAgICAgPyBcIlJFTU9WQUxcIlxuICAgICAgICAgICAgOiBcIlVQREFURVwiLFxuICAgICAgICAgIHJlc291cmNlTGFiZWw6IGlkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICB9O1xuXG5jb25zdCB0cmFuc2Zvcm1EaWZmRm9yUmVzb3VyY2VUeXBlcyA9IGFzeW5jIChcbiAgZGlmZjogU3RhY2tSYXdEaWZmXG4pOiBQcm9taXNlPE5pY2VyRGlmZltdPiA9PiB7XG4gIGNvbnN0IHJlc3VsdDogTmljZXJEaWZmW10gPSBbXTtcbiAgZm9yIChjb25zdCBkIG9mIE9iamVjdC5lbnRyaWVzKGRpZmYucmF3RGlmZikuZmlsdGVyKFxuICAgIChba10pID0+ICFbXCJpYW1DaGFuZ2VzXCIsIFwic2VjdXJpdHlHcm91cENoYW5nZXNcIl0uaW5jbHVkZXMoaylcbiAgKSkge1xuICAgIGNvbnN0IHsgZGlmZkNvbGxlY3Rpb25LZXksIGRpZmZDb2xsZWN0aW9uIH0gPSBkaWZmVmFsaWRhdG9yKGQpO1xuICAgIGlmIChkaWZmQ29sbGVjdGlvbi5kaWZmZXJlbmNlQ291bnQgPiAwKSB7XG4gICAgICBkaWZmQ29sbGVjdGlvbi5mb3JFYWNoRGlmZmVyZW5jZShcbiAgICAgICAgcHJvY2Vzc0luZGl2aWR1YWxEaWZmKHJlc3VsdCwgZGlmZkNvbGxlY3Rpb25LZXkpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5leHBvcnQgY29uc3QgdHJhbnNmb3JtRGlmZiA9IGFzeW5jIChcbiAgZGlmZjogU3RhY2tSYXdEaWZmXG4pOiBQcm9taXNlPE5pY2VyU3RhY2tEaWZmPiA9PiB7XG4gIGlmIChkaWZmLnJhd0RpZmYuaXNFbXB0eSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGFja05hbWU6IGRpZmYuc3RhY2tOYW1lLFxuICAgICAgcmF3OiBcIlRoZXJlIHdlcmUgbm8gZGlmZmVyZW5jZXNcIixcbiAgICAgIGRpZmY6IFtdLFxuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHN0YWNrTmFtZTogZGlmZi5zdGFja05hbWUsXG4gICAgcmF3OiBhd2FpdCBidWlsZFJhdyhkaWZmKSxcbiAgICBkaWZmOiBbXG4gICAgICAuLi4oYXdhaXQgdHJhbnNmb3JtSWFtQ2hhbmdlcyhkaWZmKSksXG4gICAgICAuLi4oYXdhaXQgdHJhbnNmb3JtU2VjdXJpdHlHcm91cENoYW5nZXMoZGlmZikpLFxuICAgICAgLi4uKGF3YWl0IHRyYW5zZm9ybURpZmZGb3JSZXNvdXJjZVR5cGVzKGRpZmYpKSxcbiAgICBdLFxuICB9O1xufTtcbiJdfQ==